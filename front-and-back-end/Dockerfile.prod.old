# syntax=docker/dockerfile:1

ARG NODE_VERSION=20.11.1
ARG PNPM_VERSION=10.26.2


#docker file for production build of next.js app
################################################################################
# Base image
FROM node:${NODE_VERSION}-alpine AS base
WORKDIR /usr/src/app

# Install pnpm
RUN npm install -g pnpm@${PNPM_VERSION}

################################################################################
# Dependencies (needed for build)
FROM base AS deps

COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

################################################################################
# Build stage
FROM deps AS build

COPY . .
RUN pnpm run build

################################################################################
# Runtime stage (minimal)
FROM node:${NODE_VERSION}-alpine AS final
WORKDIR /usr/src/app

ENV NODE_ENV=production
USER node

# Copy standalone output
COPY --from=build /usr/src/app/.next/standalone ./
COPY --from=build /usr/src/app/.next/static ./.next/static
COPY --from=build /usr/src/app/public ./public

EXPOSE 3000

CMD ["node", "server.js"]